From da2cbdcd70509093171f4807c51d92b7636add9f Mon Sep 17 00:00:00 2001
From: Michael Roe <michael-roe@users.noreply.github.com>
Date: Tue, 17 Jan 2023 20:15:38 +0000
Subject: [PATCH 3/5] Use cpu_features on RISC-V platforms

Signed-off-by: Michael Roe <michael-roe@users.noreply.github.com>
---
 .github/workflows/run-tests.yml | 2 +-
 CMakeLists.txt                  | 2 +-
 cpu_features                    | 2 +-
 tmpl/volk_cpu.tmpl.c            | 6 ++++++
 4 files changed, 9 insertions(+), 3 deletions(-)

diff --git a/.github/workflows/run-tests.yml b/.github/workflows/run-tests.yml
index 215ded6..1b7024d 100644
--- a/.github/workflows/run-tests.yml
+++ b/.github/workflows/run-tests.yml
@@ -114,7 +114,7 @@ jobs:
           submodules: 'recursive'
       - uses: uraimo/run-on-arch-action@v2.5.0
         name: Build in non-x86 container
-        continue-on-error: ${{ contains(fromJson('["ppc64le", "s390x", "riscv64"]'), matrix.arch) || contains(fromJson('["clang-14"]'), matrix.compiler.name) }}
+        continue-on-error: ${{ contains(fromJson('["ppc64le", "s390x"]'), matrix.arch) || contains(fromJson('["clang-14"]'), matrix.compiler.name) }}
         id: build
         with:
           arch: ${{ matrix.arch }}
diff --git a/CMakeLists.txt b/CMakeLists.txt
index 2ee2c72..92d5097 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -121,7 +121,7 @@ endif(MSVC)
 
 # cpu_features - sensible defaults, user settable option
 if(CMAKE_SYSTEM_PROCESSOR MATCHES
-    "(^mips)|(^arm)|(^aarch64)|(x86_64)|(AMD64|amd64)|(^i.86$)|(^powerpc)|(^ppc)")
+    "(^mips)|(^arm)|(^aarch64)|(x86_64)|(AMD64|amd64)|(^i.86$)|(^powerpc)|(^ppc)|(^riscv)")
   option(VOLK_CPU_FEATURES "Volk uses cpu_features" ON)
 else()
   option(VOLK_CPU_FEATURES "Volk uses cpu_features" OFF)
diff --git a/cpu_features b/cpu_features
index 188d0d3..4590768 160000
--- a/cpu_features
+++ b/cpu_features
@@ -1 +1 @@
-Subproject commit 188d0d3c383689cdb6bb70dc6da2469faec84f61
+Subproject commit 4590768e530a470a8fb8917dafee69932831c854
diff --git a/tmpl/volk_cpu.tmpl.c b/tmpl/volk_cpu.tmpl.c
index a11a626..a4a06b0 100644
--- a/tmpl/volk_cpu.tmpl.c
+++ b/tmpl/volk_cpu.tmpl.c
@@ -25,6 +25,8 @@
 #include "cpuinfo_mips.h"
 #elif defined(CPU_FEATURES_ARCH_PPC)
 #include "cpuinfo_ppc.h"
+#elif defined(CPU_FEATURES_ARCH_RISCV)
+#include "cpuinfo_riscv.h"
 #endif
 
 // This is required for MSVC
@@ -46,6 +48,10 @@ static int i_can_has_${arch.name} (void) {
         %elif "mips" in arch.name:
 #if defined(CPU_FEATURES_ARCH_MIPS)
     if (GetMipsInfo().features.${check} == 0){ return 0; }
+#endif
+        %elif "riscv" in arch.name:
+#if defined(CPU_FEATURES_ARCH_RISCV)
+    if (GetRiscvInfo().features.${check} == 0){ return 0; }
 #endif
         %else:
 #if defined(CPU_FEATURES_ARCH_X86)
-- 
2.39.2

